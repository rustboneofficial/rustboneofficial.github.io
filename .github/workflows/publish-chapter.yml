name: ðŸ“… Publish Chapter

on:
  workflow_dispatch:
    inputs:
      chapter_number:
        description: 'Chapter number to publish (e.g., 6)'
        required: true
        type: number
      release_date:
        description: 'Release date (ISO 8601, optional - defaults to now)'
        required: false
        type: string

jobs:
  publish-chapter:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: ðŸ“Š Calculate chapter checksum
        id: checksum
        run: |
          CHAPTER_FILE="web/src/assets/data/chapters/chapter-$(printf '%02d' ${{ inputs.chapter_number }}).json"
          
          # Verificar que el archivo existe
          if [ ! -f "$CHAPTER_FILE" ]; then
            echo "âŒ ERROR: $CHAPTER_FILE does not exist!"
            exit 1
          fi
          
          # Calcular SHA-256
          CHECKSUM=$(sha256sum "$CHAPTER_FILE" | awk '{print $1}')
          echo "checksum=sha256:$CHECKSUM" >> $GITHUB_OUTPUT
          
          # Calcular tamaÃ±o
          SIZE=$(stat -c%s "$CHAPTER_FILE")
          echo "size=$SIZE" >> $GITHUB_OUTPUT
          
          echo "âœ… Checksum: sha256:$CHECKSUM"
          echo "âœ… Size: $SIZE bytes"
      
      - name: ðŸ“ Update public-chapters.json
        run: |
          CHAPTER_ID="chapter-$(printf '%02d' ${{ inputs.chapter_number }})"
          CHAPTER_FILE="chapters/chapter-$(printf '%02d' ${{ inputs.chapter_number }}).json"
          CHECKSUM="${{ steps.checksum.outputs.checksum }}"
          SIZE="${{ steps.checksum.outputs.size }}"
          
          # Release date (usar input o fecha actual)
          if [ -n "${{ inputs.release_date }}" ]; then
            RELEASE_DATE="${{ inputs.release_date }}"
          else
            RELEASE_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          fi
          
          # Script Node.js para actualizar JSON
          node -e "
            const fs = require('fs');
            const publicChaptersPath = 'web/src/assets/data/public-chapters.json';
            
            // Leer JSON actual
            const data = JSON.parse(fs.readFileSync(publicChaptersPath, 'utf8'));
            
            // Marcar todos los capÃ­tulos anteriores como NO nuevos
            data.publicChapters.forEach(ch => {
              ch.isNew = false;
            });
            
            // Verificar si ya existe
            const existingIndex = data.publicChapters.findIndex(ch => ch.id === '$CHAPTER_ID');
            
            const newChapter = {
              id: '$CHAPTER_ID',
              file: '$CHAPTER_FILE',
              releaseDate: '$RELEASE_DATE',
              checksum: '$CHECKSUM',
              size: parseInt('$SIZE'),
              isNew: true
            };
            
            if (existingIndex !== -1) {
              console.log('âš ï¸  Chapter already public, updating metadata...');
              data.publicChapters[existingIndex] = newChapter;
            } else {
              console.log('âœ… Adding new chapter to public list...');
              data.publicChapters.push(newChapter);
              
              // Ordenar por ID
              data.publicChapters.sort((a, b) => a.id.localeCompare(b.id));
            }
            
            // Actualizar metadata de notificaciones
            data.notifications = {
              enabled: true,
              latestChapter: '$CHAPTER_ID',
              message: \`Chapter ${{ inputs.chapter_number }} is now available to read!\`
            };
            
            // Actualizar timestamp
            data.lastUpdated = new Date().toISOString();
            data.version = '1.0';
            
            // Guardar
            fs.writeFileSync(publicChaptersPath, JSON.stringify(data, null, 2));
            
            console.log('âœ… public-chapters.json updated successfully!');
          "
      
      - name: ðŸ“¤ Commit changes
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          git add web/src/assets/data/public-chapters.json
          
          if git diff --staged --quiet; then
            echo "âš ï¸  No changes to commit"
          else
            git commit -m "ðŸ“… Publish chapter-$(printf '%02d' ${{ inputs.chapter_number }})"
            git push
            echo "âœ… Changes pushed to repository"
          fi
      
      - name: ðŸš€ Trigger manual deploy workflow
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            console.log('ðŸš€ Triggering manual_deploy workflow...');
            
            try {
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'manual_deploy.yml',
                ref: 'main'
              });
              
              console.log('âœ… Manual deploy workflow triggered successfully!');
            } catch (error) {
              console.error('âŒ Error triggering workflow:', error.message);
              throw error;
            }
      
      - name: âœ… Summary
        run: |
          echo "## ðŸŽ‰ Chapter Published!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Chapter**: chapter-$(printf '%02d' ${{ inputs.chapter_number }})" >> $GITHUB_STEP_SUMMARY
          echo "- **Release Date**: ${{ inputs.release_date || 'Now' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Checksum**: ${{ steps.checksum.outputs.checksum }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Size**: ${{ steps.checksum.outputs.size }} bytes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Chapter is now committed to repository" >> $GITHUB_STEP_SUMMARY
          echo "ðŸš€ Manual deploy workflow has been triggered" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ Changes will be live in 2-5 minutes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“± Users will be notified within 5 minutes via in-app polling" >> $GITHUB_STEP_SUMMARY
